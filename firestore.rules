rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // ============================================================
    // Global Helper Functions
    // ============================================================
    function isAdmin() {
      return request.auth != null && request.auth.token.role == "admin";
    }

    function isAuthenticated() {
      return request.auth != null;
    }

    function isMember(memberList) {
      return isAuthenticated()
             && memberList is list
             && request.auth.uid in memberList;
    }

    function workspaceDoc(workspaceId) {
      return get(/databases/$(database)/documents/workspaces/$(workspaceId));
    }

    function isWorkspaceOwner(workspaceId) {
      return isAuthenticated()
             && workspaceId is string
             && workspaceDoc(workspaceId).data.ownerId == request.auth.uid;
    }

    function canManageWorkspace(workspaceId) {
      return isWorkspaceOwner(workspaceId);
    }

    function isWorkspaceMemberDoc(workspaceId, userId) {
      return isAuthenticated()
             && workspaceId is string
             && userId is string
             && exists(/databases/$(database)/documents/workspaces/$(workspaceId)/members/$(userId));
    }

    function invitationDocById(invitationId) {
      return get(/databases/$(database)/documents/workspace_invitations/$(invitationId));
    }

    function canAccessWorkspace(workspaceId) {
      return isAuthenticated()
             && workspaceId is string
             && (
                isWorkspaceOwner(workspaceId)
                || isWorkspaceMemberDoc(workspaceId, request.auth.uid)
                || isMember(workspaceDoc(workspaceId).data.members)
              );
    }

    function canAccessProject(projectId) {
      return isAuthenticated()
             && projectId is string
             && (
                get(/databases/$(database)/documents/projects/$(projectId)).data.userId == request.auth.uid
                || isMember(get(/databases/$(database)/documents/projects/$(projectId)).data.memberIds)
              );
    }

    function getMemberData(workspaceId, userId) {
      return get(/databases/$(database)/documents/workspaces/$(workspaceId)/members/$(userId)).data;
    }

    function checkPermission(workspaceId, resource, action) {
      let member = getMemberData(workspaceId, request.auth.uid);
      let roleId = member.roleId;
      
      return (roleId == "admin")
        || (roleId == "editor" && (
             (resource == "documents" && (action in ["read", "create", "update"]))
             || (resource == "tasks" && (action in ["read", "create", "update", "delete"]))
             || (resource == "projects" && (action in ["read", "update"]))
           ))
        || (roleId == "viewer" && action == "read");
    }

    // Allow admins full access
    match /{document=**} {
      allow read, write: if isAdmin();
    }

    // ============================================================
    // Users can only read/write their own profile
    // ============================================================
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ============================================================
    // Projects Collection (Legacy - for compatibility)
    // ============================================================
    match /projects/{projectId} {
      allow create: if isAuthenticated()
                    && request.resource.data.userId == request.auth.uid
                    && (
                      !(request.resource.data.memberIds is list)
                      || isMember(request.resource.data.memberIds)
                    );
      allow read: if isAuthenticated()
                  && (
                    resource.data.userId == request.auth.uid
                    || isMember(resource.data.memberIds)
                    || (
                      resource.data.workspaceId is string
                      && canAccessWorkspace(resource.data.workspaceId)
                    )
                  );
      allow update: if isAuthenticated()
                    && (
                      resource.data.userId == request.auth.uid
                      || (
                        isMember(resource.data.memberIds)
                        && request.resource.data.userId == resource.data.userId
                        && request.resource.data.name == resource.data.name
                        && request.resource.data.icon == resource.data.icon
                        && request.resource.data.color == resource.data.color
                        && request.resource.data.kind == resource.data.kind
                        && request.resource.data.visibility == resource.data.visibility
                        && request.resource.data.workspaceId == resource.data.workspaceId
                        && request.resource.data.createdAt == resource.data.createdAt
                        && request.resource.data.documentCount == resource.data.documentCount
                        && request.resource.data.memberIds is list
                        && request.resource.data.memberIds.size() == resource.data.memberIds.size() - 1
                        && !(request.auth.uid in request.resource.data.memberIds)
                      )
                    );
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ============================================================
    // Spaces, Folders and Lists (Flexible Hierarchy)
    // ============================================================
    match /spaces/{spaceId} {
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        (resource.data.workspaceId is string && canAccessWorkspace(resource.data.workspaceId))
      );
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    match /folders/{folderId} {
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        get(/databases/$(database)/documents/spaces/$(resource.data.spaceId)).data.userId == request.auth.uid
      );
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    match /lists/{listId} {
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        get(/databases/$(database)/documents/spaces/$(resource.data.spaceId)).data.userId == request.auth.uid
      );
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ============================================================
    // Documents - owner access + published docs are public
    // ============================================================
    match /documents/{documentId} {
      // Allow read if user is owner or doc is published or has RBAC read permission
      allow read: if (isAuthenticated()
                      && (
                        resource.data.userId == request.auth.uid
                        || (resource.data.projectId != null && canAccessProject(resource.data.projectId))
                        || (
                          resource.data.workspaceId is string
                          && (canAccessWorkspace(resource.data.workspaceId) && checkPermission(resource.data.workspaceId, "documents", "read"))
                        )
                      ))
                  || resource.data.isPublished == true;
      allow create: if isAuthenticated()
                    && request.resource.data.userId == request.auth.uid
                    && (
                      (request.resource.data.projectId != null && canAccessProject(request.resource.data.projectId))
                      || (
                        request.resource.data.workspaceId is string
                        && canAccessWorkspace(request.resource.data.workspaceId)
                        && checkPermission(request.resource.data.workspaceId, "documents", "create")
                      )
                      || (
                        request.resource.data.workspaceId == null
                        && isMember(request.resource.data.allowedUserIds)
                      )
                    );
      allow update: if isAuthenticated()
                    && (
                      resource.data.userId == request.auth.uid
                      || (request.resource.data.projectId != null && canAccessProject(request.resource.data.projectId))
                      || (
                        resource.data.workspaceId is string
                        && canAccessWorkspace(resource.data.workspaceId)
                        && checkPermission(resource.data.workspaceId, "documents", "update")
                      )
                      || (
                        resource.data.workspaceId == null
                        && isMember(resource.data.allowedUserIds)
                      )
                    );
      allow delete: if isAuthenticated()
                    && (
                      resource.data.userId == request.auth.uid
                      || (request.resource.data.projectId != null && canAccessProject(request.resource.data.projectId))
                      || (
                        resource.data.workspaceId is string
                        && canAccessWorkspace(resource.data.workspaceId)
                        && checkPermission(resource.data.workspaceId, "documents", "delete")
                      )
                    );

      // ============================================================
      // Subcollections for Collaboration
      // ============================================================
      match /presence/{userId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null && request.auth.uid == userId;
      }
      
      match /invitations/{invitationId} {
        allow read: if request.auth != null && (request.auth.token.email == resource.data.email || request.auth.uid == resource.data.invitedBy);
        allow create: if request.auth != null;
        allow update, delete: if request.auth != null && request.auth.uid == resource.data.invitedBy;
      }
    }

    // ============================================================
    // Tags Collection
    // ============================================================
    match /tags/{tagId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null
                          && resource.data.userId == request.auth.uid;
    }

    // ============================================================
    // Templates Collection
    // ============================================================
    match /templates/{templateId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null
                              && resource.data.userId == request.auth.uid;
    }

    // ============================================================
    // Tasks Collection (independent or embedded in notes)
    // ============================================================
    match /tasks/{taskId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        (resource.data.workspaceId is string && checkPermission(resource.data.workspaceId, "tasks", "read"))
      );
      allow create: if isAuthenticated() && (
        request.resource.data.userId == request.auth.uid ||
        (request.resource.data.workspaceId is string && checkPermission(request.resource.data.workspaceId, "tasks", "create"))
      );
      allow update: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        (resource.data.workspaceId is string && checkPermission(resource.data.workspaceId, "tasks", "update"))
      );
      allow delete: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        (resource.data.workspaceId is string && checkPermission(resource.data.workspaceId, "tasks", "delete"))
      );
    }

    // ============================================================
    // Document Versions Collection
    // ============================================================
    match /document_versions/{versionId} {
      allow read: if request.auth != null
                  && request.auth.uid == resource.data.userId
                  || request.auth != null && resource.data.userId == request.data.createdBy;
      allow create: if request.auth != null;
      allow update: if request.auth != null
                         && (request.auth.uid == resource.data.userId || request.auth.uid == resource.data.createdBy);
      allow delete: if request.auth != null
                         && (request.auth.uid == resource.data.userId || request.auth.uid == resource.data.createdBy);
    }

    // ============================================================
    // Comments Collection
    // ============================================================
    match /comments/{commentId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null
                         && request.auth.uid == resource.data.userId;
    }

    // ============================================================
    // Reminders Collection
    // ============================================================
    match /reminders/{reminderId} {
      allow read, write: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
    }

    // ============================================================
    // Related Notes Collection (pre-calculated relationships)
    // ============================================================
    match /related_notes/{relationId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow delete: if request.auth != null
                         && request.auth.uid == resource.data.userId;
    }

    // ============================================================
    // Embeddings Collection (for semantic search)
    // ============================================================
    match /embeddings/{embeddingId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null
                         && request.auth.uid == resource.data.userId;
    }

    // ============================================================
    // Workspace Analytics Collection
    // ============================================================
    match /workspace_analytics/{analyticsId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null
                         && request.auth.uid == resource.data.userId;
    }

    // ============================================================
    // Web Clips Collection
    // ============================================================
    match /web_clips/{clipId} {
      allow read, write: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
    }

    // ============================================================
    // Workspaces (for collaboration)
    // ============================================================
    match /workspaces/{workspaceId} {
      allow read: if isAuthenticated()
                  && (
                    resource.data.ownerId == request.auth.uid
                    || isMember(resource.data.members)
                    || exists(/databases/$(database)/documents/workspaces/$(workspaceId)/members/$(request.auth.uid))
                  );
      allow create: if isAuthenticated()
                    && request.resource.data.ownerId == request.auth.uid
                    && isMember(request.resource.data.members);
      allow update, delete: if isAuthenticated()
                            && resource.data.ownerId == request.auth.uid;

      match /members/{memberId} {
        allow read: if isAuthenticated()
                    && (
                      canAccessWorkspace(workspaceId)
                      || request.auth.uid == memberId
                      || isWorkspaceMemberDoc(workspaceId, request.auth.uid)
                    );
        allow create: if isAuthenticated()
                      && (
                        canManageWorkspace(workspaceId)
                        || (
                          request.auth.uid == memberId
                          && request.resource.data.uid == request.auth.uid
                          && request.resource.data.invitationId is string
                          && request.auth.token.email is string
                          && request.resource.data.email is string
                          && request.resource.data.email.lower() == request.auth.token.email.lower()
                          && invitationDocById(request.resource.data.invitationId).data.invitedEmail is string
                          && invitationDocById(request.resource.data.invitationId).data.workspaceId == workspaceId
                          && invitationDocById(request.resource.data.invitationId).data.invitedEmail.lower() == request.auth.token.email.lower()
                          && invitationDocById(request.resource.data.invitationId).data.status == "pending"
                        )
                      );
        allow update: if canManageWorkspace(workspaceId)
                      || request.auth.uid == memberId;
        allow delete: if canManageWorkspace(workspaceId)
                      || request.auth.uid == memberId;
      }
    }

    // ============================================================
    // Workspace invitations (email-based)
    // ============================================================
    match /workspace_invitations/{invitationId} {
      allow create: if isAuthenticated()
                    && request.resource.data.invitedBy == request.auth.uid
                    && request.resource.data.workspaceId is string
                    && canManageWorkspace(request.resource.data.workspaceId)
                    && request.resource.data.invitedEmail is string
                    && request.resource.data.status == "pending";

      allow read: if isAuthenticated()
                  && (
                    canManageWorkspace(resource.data.workspaceId)
                    || resource.data.invitedBy == request.auth.uid
                    || (
                      request.auth.token.email is string
                      && resource.data.invitedEmail is string
                      && request.auth.token.email.lower() == resource.data.invitedEmail.lower()
                    )
                  );

      allow update: if isAuthenticated()
                    && (
                      canManageWorkspace(resource.data.workspaceId)
                      || resource.data.invitedBy == request.auth.uid
                      || (
                        request.auth.token.email is string
                        && resource.data.invitedEmail is string
                        && request.auth.token.email.lower() == resource.data.invitedEmail.lower()
                        && request.resource.data.workspaceId == resource.data.workspaceId
                        && request.resource.data.invitedEmail == resource.data.invitedEmail
                        && request.resource.data.invitedBy == resource.data.invitedBy
                        && (
                          request.resource.data.status == "accepted"
                          || request.resource.data.status == "declined"
                        )
                        && (
                          request.resource.data.status != "accepted"
                          || request.resource.data.acceptedBy == request.auth.uid
                        )
                      )
                    );

      allow delete: if isAuthenticated()
                    && canManageWorkspace(resource.data.workspaceId);
    }

    // ============================================================
    // Shared Documents (with permissions)
    // ============================================================
    match /shared_documents/{sharedDocId} {
      allow read: if request.auth != null;
      allow update: if request.auth != null
                      && request.auth.uid == resource.data.ownerId;
      allow delete: if request.auth != null && request.auth.uid == resource.data.ownerId;
    }

    // ============================================================
    // AI Usage Collection (for tracking AI usage)
    // ============================================================
    match /users/{userId}/aiUsage/{usageId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ============================================================
    // API Keys Collection
    // ============================================================
    match /api_keys/{keyId} {
      allow read, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ============================================================
    // Webhooks Collection
    // ============================================================
    match /webhooks/{webhookId} {
      allow read, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    match /webhook_logs/{logId} {
      allow read: if isAuthenticated() && get(/databases/$(database)/documents/webhooks/$(resource.data.webhookId)).data.userId == request.auth.uid;
      allow create: if isAuthenticated(); // Triggered by API
    }

    // ============================================================
    // Portfolios Collection
    // ============================================================
    match /portfolios/{portfolioId} {
      allow read, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
  }
}
